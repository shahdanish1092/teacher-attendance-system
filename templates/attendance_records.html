{% extends "base.html" %}

{% block title %}Attendance Records - Attendance System{% endblock %}

{% block body_class %}attendance-records-page{% endblock %}

{% block extra_css %}
<style>
    .teacher-info {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .teacher-photo {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #667eea;
    }

    .teacher-info h3 {
        color: #374151;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .teacher-info p {
        color: #6b7280;
        margin: 0;
    }

    .action-buttons {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .btn-outline-primary {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
    }

    .btn-outline-primary:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }

    .btn-info {
        background: #06b6d4;
        color: white;
    }

    .btn-info:hover {
        background: #0891b2;
        transform: translateY(-2px);
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
        transform: translateY(-2px);
    }

    .btn-primary {
        background: #3b82f6;
        color: white;
    }

    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
        transform: translateY(-2px);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .stats-card h5 {
        color: #374151;
        margin-bottom: 16px;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-item {
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .badge-present {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    .badge-absent {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .badge-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #e5e7eb;
    }

    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .form-control {
        width: 100%;
        padding: 10px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }

    .table td {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
    }

    .table tbody tr:hover {
        background-color: #f8fafc;
    }

    .row-present {
        background-color: #f0fdf4;
    }

    .row-absent {
        background-color: #fef2f2;
    }

    .status-badge {
        padding: 6px 12px;
        font-size: 12px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        color: #d1d5db;
    }

    .debug-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
    }

    .debug-info h6 {
        color: #1e40af;
        margin-bottom: 12px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .debug-info ul {
        color: #374151;
        margin-bottom: 16px;
        padding-left: 20px;
    }

    .debug-info li {
        margin-bottom: 6px;
    }

    .icon {
        width: 16px;
        height: 16px;
    }

    .icon-lg {
        width: 20px;
        height: 20px;
    }

    @media (max-width: 768px) {
        .teacher-info {
            flex-direction: column;
            text-align: center;
        }

        .btn-group {
            flex-direction: column;
            align-items: stretch;
        }

        .btn {
            justify-content: center;
        }

        .filter-section {
            grid-template-columns: 1fr;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            min-width: 600px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Teacher Info -->
<div class="teacher-info">
    {% if teacher_photo %}
    <img src="{{ teacher_photo }}" alt="Teacher Photo" class="teacher-photo">
    {% endif %}
    <div>
        <h3>
            <svg class="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Attendance Records
        </h3>
        <p>
            <strong>
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Teacher:
            </strong> {{ teacher_name }} |
            <strong>
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                Lecture:
            </strong> {{ lecture }}
        </p>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
    <div class="btn-group">
        <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                Back to Home
            </a>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <a href="{{ url_for('clear_and_defaulters') }}" class="btn btn-info">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                View Clear & Defaulters
            </a>
            <a href="{{ url_for('export_attendance', format='excel') }}" class="btn btn-success">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export Excel
            </a>
            <a href="{{ url_for('export_attendance', format='word') }}" class="btn btn-primary">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export Word
            </a>
            <button onclick="refreshData()" class="btn btn-secondary">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            </button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stats-card">
        <h5>
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
            </svg>
            Overall Statistics
        </h5>
        <div class="stat-item">
            <span class="badge badge-present">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Present: {{ present_count }}
            </span>
        </div>
        <div class="stat-item">
            <span class="badge badge-absent">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Absent: {{ absent_count }}
            </span>
        </div>
        <div class="stat-item">
            <span class="badge badge-secondary">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                Total Records: {{ records|length }}
            </span>
        </div>
    </div>
    <div class="stats-card">
        <h5>
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Today's Statistics
        </h5>
        <div class="stat-item">
            <span class="badge badge-present">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Present Today: {{ present_today }}
            </span>
        </div>
        <div class="stat-item">
            <span class="badge badge-absent">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                Absent Today: {{ absent_today }}
            </span>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="filter-section">
    <input type="text" id="searchInput" class="form-control" placeholder="Search by Student ID or Name...">
    <select id="statusFilter" class="form-control">
        <option value="">All Status</option>
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
    </select>
    <select id="dateFilter" class="form-control">
        <option value="">All Dates</option>
        {% set dates = [] %}
        {% for record in records %}
            {% if record[2] not in dates %}
                {% set _ = dates.append(record[2]) %}
                <option value="{{ record[2] }}">{{ record[2] }}</option>
            {% endif %}
        {% endfor %}
    </select>
</div>

<!-- Attendance Table -->
<div class="table-container">
    <table class="table" id="attendanceTable">
        <thead>
            <tr>
                <th>Student ID</th>
                <th>Student Name</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Lecture</th>
            </tr>
        </thead>
        <tbody>
        {% for record in records %}
            <tr class="{% if record[4] == 'Present' %}row-present{% else %}row-absent{% endif %}"
                data-student-id="{{ record[0] }}"
                data-student-name="{{ record[1] }}"
                data-status="{{ record[4] }}"
                data-date="{{ record[2] }}">
                <td><strong>{{ record[0] }}</strong></td>
                <td>{{ record[1] }}</td>
                <td>{{ record[2] }}</td>
                <td>{{ record[3] }}</td>
                <td>
                    {% if record[4] == 'Present' %}
                        <span class="badge badge-present status-badge">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Present
                        </span>
                    {% else %}
                        <span class="badge badge-absent status-badge">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Absent
                        </span>
                    {% endif %}
                </td>
                <td>{{ record[5] }}</td>
            </tr>
        {% endfor %}
        {% if records|length == 0 %}
            <tr>
                <td colspan="6" class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                    </svg>
                    <br>
                    No attendance records found for {{ lecture }}.
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>
</div>

<!-- Debug Info (only show if no records) -->
{% if records|length == 0 %}
<div class="debug-info">
    <h6>
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Debug Information:
    </h6>
    <ul>
        <li>Current Lecture: {{ lecture }}</li>
        <li>Teacher: {{ teacher_name }}</li>
        <li>Check if students are enrolled in the database</li>
        <li>Verify face recognition is working in Mark Attendance</li>
    </ul>
    <a href="/debug/db_status" target="_blank" class="btn btn-outline-primary" style="display: inline-flex;">
        Check Database Status
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Search and filter functionality
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('statusFilter').addEventListener('change', filterTable);
    document.getElementById('dateFilter').addEventListener('change', filterTable);

    function filterTable() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;

        const rows = document.querySelectorAll('#attendanceTable tbody tr');

        rows.forEach(row => {
            if (row.cells.length < 6) return; // Skip empty rows

            const studentId = row.getAttribute('data-student-id').toLowerCase();
            const studentName = row.getAttribute('data-student-name').toLowerCase();
            const status = row.getAttribute('data-status');
            const date = row.getAttribute('data-date');

            const matchesSearch = studentId.includes(searchText) || studentName.includes(searchText);
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesDate = !dateFilter || date === dateFilter;

            row.style.display = (matchesSearch && matchesStatus && matchesDate) ? '' : 'none';
        });
    }

    function refreshData() {
        window.location.reload();
    }

    // Auto-refresh every 30 seconds if on the page
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            refreshData();
        }
    }, 30000);

    console.log('Attendance records page loaded successfully');
</script>
{% endblock %}